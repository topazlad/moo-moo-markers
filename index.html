<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Moo Moo Markers v1.6.3 - Uniform Button Size</title>
<!-- v1.6.3: Ensured all menu buttons have a consistent size. -->
<style>
/* Basic reset */
* { box-sizing: border-box; }
body, html {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
  font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
  background: #faf9f7;
  color: #2c3e50;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: background .3s ease, color .3s ease;
}

/* Dark mode styling */
body.dark-mode {
  background: #121212;
  color: #e0e0e0;
}
body.dark-mode nav#controls,
body.dark-mode #side-menu {
  background: #1e1e1e;
  box-shadow: 0 -3px 10px rgba(255,255,255,.08);
}
body.dark-mode nav#controls button,
body.dark-mode .action-btn,
body.dark-mode #darkModeToggleBtn.dark,
body.dark-mode #menuBtn{
  box-shadow: 5px 5px 10px #0a0a0a, -5px -5px 10px #323232;
}
body.dark-mode nav#controls button:hover,
body.dark-mode nav#controls button:focus,
body.dark-mode .action-btn:hover,
body.dark-mode .action-btn:focus,
body.dark-mode #darkModeToggleBtn.dark:hover,
body.dark-mode #menuBtn:hover {
  box-shadow: 6px 6px 12px #0a0a0a, -6px -6px 12px #323232;
}
body.dark-mode nav#controls button:active,
body.dark-mode .action-btn:active,
body.dark-mode #darkModeToggleBtn.dark:active,
body.dark-mode #menuBtn:active {
  background: #0a0a0a;
  box-shadow: inset 2px 2px 6px #050505;
}
body.dark-mode p#instructions { color: #aaa; }
body.dark-mode .popup {
  background: #1e1e1e;
  color: #e0e0e0;
  box-shadow: 0 10px 30px rgba(0,0,0,.5);
}
body.dark-mode .popup h2 { color: #6fcf97; }
body.dark-mode .popup input {
  background: #2c2c2c;
  color: #e0e0e0;
  border: 1px solid #444;
}
body.dark-mode .leaflet-popup-content-wrapper,
body.dark-mode .leaflet-popup-tip {
  background: #1e1e1e;
  color: #e0e0e0;
}
body.dark-mode .leaflet-popup-content-wrapper {
  background: #1e1e1e;
  color: #e0e0e0;
}
body.dark-mode .leaflet-popup-tip {
  background: #1e1e1e;
}
body.dark-mode .cow-marker {
  text-shadow: 1px 1px 2px #000;
}
body.dark-mode .marker-popup h3 {
  text-shadow: 1px 1px 2px #fff;
}
body.dark-mode #menuBtn {
  color: #e0e0e0;
}
body.dark-mode #menuBtn:hover,
body.dark-mode #menuBtn:focus {
  background-color: rgba(255, 255, 255, 0.1);
}
body.dark-mode #menuBtn:active {
  background: rgba(255, 255, 255, 0.2);
}

#map {
  flex-grow: 1;
  position: relative;
  z-index: 0;
}

nav#controls {
  background: #fff;
  box-shadow: 0 -3px 10px rgba(0,0,0,.12);
  padding: 10px 12px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  user-select: none;
  border-top-left-radius: 12px;
  border-top-right-radius: 12px;
  z-index: 10;
  flex-shrink: 0;
  flex-wrap: wrap;
  overflow-x: hidden;
  transition: background .3s ease, box-shadow .3s ease;
}

button {
  background: linear-gradient(145deg, #6fcf97, #27ae60);
  border: none;
  color: #fff;
  font-weight: 700;
  font-size: 1.5rem;
  width: 50px;
  height: 50px;
  border-radius: 14px;
  cursor: pointer;
  box-shadow: 5px 5px 10px #1e7c45, -5px -5px 10px #48d67f;
  transition: all .2s ease;
  user-select: none;
  touch-action: manipulation;
  display: flex;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 0;
  position: relative;
}
button:hover, button:focus {
  transform: translateY(-2px);
  box-shadow: 6px 6px 12px #196232, -6px -6px 12px #55e18f;
  outline: none;
}
button:active {
  transform: translateY(1px);
  background: #1e7c45;
  box-shadow: inset 2px 2px 6px #144c2d;
}

/* Specific styling for other buttons */
#darkModeToggleBtn.light {
  background: linear-gradient(145deg, #f1c40f, #f39c12);
}
#darkModeToggleBtn.light:hover {
  box-shadow: 6px 6px 12px #c27c0e, -6px -6px 12px #ffc140;
}
#darkModeToggleBtn.light:active {
  background: #c27c0e;
  box-shadow: inset 2px 2px 6px #945f0b;
}
.popup .save-btn,
.popup .confirm-btn,
.popup .ok-btn {
  background: #27ae60;
  font-size: 1.5rem;
  width: 50px;
  height: 50px;
}
.popup .cancel-btn,
.popup .delete-action {
  background: #e74c3c;
  font-size: 1.5rem;
  width: 50px;
  height: 50px;
}
.popup .edit-action {
  background: #3498db;
  font-size: 1.5rem;
  width: 50px;
  height: 50px;
}
p#instructions {
  text-align: center;
  font-size: .85rem;
  color: #555;
  user-select: none;
  margin-top: 8px;
  padding: 0 15px;
}
.cow-marker {
  font-size: 40px;
  color: #27ae60;
  text-shadow: 1px 1px 2px #27ae60;
  transition: transform .3s ease;
  cursor: pointer;
  user-select: none;
}
.cow-marker.active {
  transform: scale(2.2);
  z-index: 9999;
  filter: drop-shadow(0 0 5px rgba(39,174,96,.8));
}
body.dark-mode .cow-marker {
  text-shadow: 1px 1px 2px #000;
}
.marker-popup h3 {
  font-size: 1.5rem;
  color: #27ae60;
  text-shadow: 1px 1px 2px #000;
  margin-top: 0;
  margin-bottom: 8px;
}

/* Leaflet popup dark mode styling */
.leaflet-popup-content-wrapper,
.leaflet-popup-tip {
  background: #fff;
  color: #2c3e50;
}
body.dark-mode .leaflet-popup-content-wrapper {
  background: #1e1e1e;
  color: #e0e0e0;
}
body.dark-mode .leaflet-popup-tip {
  background: #1e1e1e;
}

/* Close button styling */
.close-popup-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  font-size: 1.2rem;
  cursor: pointer;
  color: #666;
  font-weight: bold;
  line-height: 1;
  transition: color 0.2s ease;
  padding: 4px;
}

.close-popup-btn:hover {
  color: #e74c3c;
}
body.dark-mode .close-popup-btn {
  color: #ccc;
}
body.dark-mode .close-popup-btn:hover {
  color: #e74c3c;
}

/* Precise vertical alignment for marker cluster icon */
.cow-cluster-icon {
  background: #27ae60;
  border-radius: 50%;
  color: #fff;
  font-weight: 700;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 2px 2px 5px rgba(0,0,0,.3);
  transition: width .2s ease, height .2s ease;
  font-size: 1.5rem;
}
.cow-cluster-icon .content-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transform: translateY(2px);
}
.cow-cluster-icon span.count {
  font-size: 0.8em;
  line-height: 1;
}
.cow-cluster-icon span.cow-emoji {
  font-size: 1.2em;
  line-height: 1;
}
.cow-cluster-icon-small { font-size: .9rem; }
.cow-cluster-icon-small .cow-emoji { font-size: 1.2rem; }

.overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,.4);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 99999;
  visibility: hidden;
  opacity: 0;
  transition: opacity .25s ease;
}
.overlay.visible {
  visibility: visible;
  opacity: 1;
}
.popup {
  background: #fff;
  padding: 20px;
  border-radius: 18px;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
  text-align: center;
  max-width: 90vw;
  user-select: none;
  position: relative;
}
.popup h2 {
  margin: 0 0 12px;
  font-weight: 700;
  color: #27ae60;
}
#qrCodeContainer {
  margin: 0 auto 18px;
  max-width: 300px;
  max-height: 300px;
}
#video {
  width: 100%;
  max-width: 320px;
  border-radius: 12px;
  background: #000;
}
#scanMessage {
  margin: 12px 0 0;
  color: #333;
  font-size: .9rem;
  font-family: monospace;
}
#downloadQRBtn {
  width: auto;
  height: auto;
  padding: 8px 18px;
}
.leaflet-popup-content small {
  font-size: .7rem;
  color: #666;
  display: block;
}
.action-btn {
  font-size: 1.5rem;
  padding: 0;
  width: 50px;
  height: 50px;
  border-radius: 14px;
  cursor: pointer;
  border: none;
  margin: 2px;
}
#importQRInput {
  display: none;
}

/* --- UPDATED MENU STYLING --- */
#menuBtn {
  font-size: 30px;
  cursor: pointer;
  color: #fff;
  line-height: 1;
  height: 50px;
  width: 50px;
  border-radius: 14px;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: all .2s ease;
  user-select: none;
  touch-action: manipulation;
  background: linear-gradient(145deg, #6fcf97, #27ae60);
  box-shadow: 5px 5px 10px #1e7c45, -5px -5px 10px #48d67f;
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 9999;
}
#menuBtn:hover,
#menuBtn:focus {
  transform: translateY(-2px);
  box-shadow: 6px 6px 12px #196232, -6px -6px 12px #55e18f;
  outline: none;
}
#menuBtn:active {
  transform: translateY(1px);
  background: #1e7c45;
  box-shadow: inset 2px 2px 6px #144c2d;
}

#side-menu {
  position: fixed;
  top: 0;
  right: -70px;
  width: 70px;
  height: 100vh;
  background: #fff;
  box-shadow: -5px 0 15px rgba(0,0,0,.15);
  z-index: 999;
  padding: 15px 0;
  transition: right .3s ease-in-out;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
}
#side-menu.visible {
  right: 0;
}
/* --- END UPDATED MENU STYLING --- */

#version-number {
  position: absolute;
  bottom: 20px;
  font-size: .8rem;
  color: #999;
}
#splash-screen .popup {
  max-width: 500px;
  text-align: left;
}
#splash-screen .popup h2 {
  text-align: center;
  font-size: 2rem;
}
#splash-screen .popup p {
  font-size: 1rem;
  line-height: 1.6;
  margin-bottom: 20px;
}
#splash-screen .popup ul {
  margin-bottom: 20px;
  padding-left: 20px;
  list-style-type: disc;
}
#splash-screen .popup li {
  margin-bottom: 8px;
}
#splash-screen .checkbox-container {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
  margin-bottom: 20px;
}
#splash-screen .ok-btn {
  font-size: 1rem;
  padding: 12px 24px;
  height: auto;
  width: auto;
}
.tooltip {
  position: fixed;
  background-color: rgba(0,0,0,.85);
  color: #fff;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: .8rem;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity .2s ease-in-out, transform .2s ease-in-out;
  z-index: 100000;
  transform: translate(-50%,0);
}
.tooltip.visible {
  opacity: 1;
  transform: translate(-50%,-10px);
}
.tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border-width: 5px;
  border-style: solid;
  border-color: rgba(0,0,0,.85) transparent transparent transparent;
}
.edit-popup-content, .search-popup-content {
  text-align: center;
}
.edit-popup-content input, .search-popup-content input {
  width: 100%;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 1rem;
  margin-bottom: 10px;
}
#locateBtn.tracking {
  box-shadow: inset 2px 2px 6px #144c2d;
  background: linear-gradient(145deg,#2d9cdb,#1f6fb0);
}
/* Updated #groupingToggleBtn to have same size as other buttons */
#groupingToggleBtn {
  display: flex;
  flex-direction: column;
  /* Removed fixed width/height here to rely on generic 'button' style */
  font-size: 1.5rem; /* Adjusted font-size to fit */
  height: 50px;
  width: 50px;
  border-radius: 14px;
}
#groupingToggleBtn .emoji {
  font-size: 1.5rem; /* Adjusted emoji size */
}
.toggle-off {
  background: linear-gradient(145deg,#d26b5d,#e74c3c)!important;
  box-shadow: inset 2px 2px 6px #943224,-5px -5px 10px #ff7866!important;
  transform:none!important;
}
.toggle-off:hover {
  box-shadow: inset 2px 2px 6px #943224,-6px -6px 12px #ff7866!important;
  transform:none!important;
}
.toggle-off:active {
  box-shadow: inset 2px 2px 6px #943224,-5px -5px 10px #ff7866!important;
  transform:none!important;
}
body.dark-mode .toggle-off {
  box-shadow: inset 2px 2px 6px #050505,-5px -5px 10px #323232!important;
  background: #0a0a0a!important;
}
body.dark-mode .toggle-off:hover {
  box-shadow: inset 2px 2px 6px #050505,-6px -6px 12px #323232!important;
}

</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
</head>
<body>
<div id="map">
  <button id="menuBtn" data-tooltip="Open/Close Menu">☰</button>
</div>
<nav id="controls">
  <button id="locateBtn" data-tooltip="Start Tracking">📍</button>
  <button id="showQRBtn" data-tooltip="Share Map QR">🖼️</button>
  <button id="scanQRBtn" data-tooltip="Scan QR Code">📷</button>
  <button id="importQRBtn" data-tooltip="Import Map from Image">📂</button>
  <input type="file" id="importQRInput" accept="image/*">
  <button id="clearBtn" data-tooltip="Clear All Cows">❌</button>
</nav>

<div id="side-menu">
  <button id="searchBtn" data-tooltip="Find a Cow">🔍</button>
  <button id="groupingToggleBtn" data-tooltip="Toggle Marker Grouping">
    <span class="emoji">🗂️</span>
  </button>
  <button id="darkModeToggleBtn" class="dark" data-tooltip="Toggle Dark Mode">⚫</button>
  <button id="showSplashBtn" data-tooltip="Show Welcome Screen">?</button>
  <button id="githubLinkBtn" data-tooltip="View on GitHub">🐙</button>
  <div id="version-number">v1.6.3</div>
</div>

<div id="splash-screen" class="overlay">
  <div class="popup">
    <h2>Welcome to Moo Moo Markers! 🐮</h2>
    <p>This is a simple map app to drop markers, name them, and share them with friends via a QR code.</p>
    <ul>
      <li><b>Add Cows:</b> Tap anywhere on the map to add a new cow marker.</li>
      <li><b>Share Maps:</b> Tap the 🖼️ button to generate a QR code of all your cow locations.</li>
      <li><b>Import Maps:</b> Tap the 📷 or 📂 button to scan a QR code from a camera or a file to load a new map.</li>
      <li><b>Locate Me:</b> Tap the 📍 button to start/stop continuous location tracking.</li>
    </ul>
    <div class="checkbox-container">
      <input type="checkbox" id="doNotShowAgainCheckbox"><label for="doNotShowAgainCheckbox">Do not show this window again</label>
    </div>
    <button class="ok-btn">Start Mapping</button>
  </div>
</div>

<div id="qrOverlay" class="overlay">
  <div class="popup">
    <h2 id="qrTitle">Share This Cow Map</h2>
    <div id="qrCodeContainer"></div>
    <button id="downloadQRBtn">Download QR</button>
  </div>
</div>

<div id="scanOverlay" class="overlay">
  <div class="popup">
    <h2 id="scanTitle">Scan Cow Map QR Code</h2>
    <video id="video" autoplay playsinline></video>
    <p id="scanMessage">Point camera at a QR code</p>
  </div>
</div>

<div id="searchOverlay" class="overlay">
  <div class="popup">
    <h2 id="searchTitle">Find a Cow</h2>
    <div class="search-popup-content">
      <input type="text" id="cowSearchInput" placeholder="Enter cow's name">
    </div>
    <div style="display:flex;justify-content:center;gap:8px;margin-top:10px;">
      <button class="action-btn save-btn" id="searchExecuteBtn">🔍</button>
      <button class="action-btn cancel-btn" id="searchCancelBtn">✖️</button>
    </div>
  </div>
</div>

<script>
window.onload = function() {
  const COW_NAMES = [
    'Bessie', 'Daisy', 'Gertrude', 'Moo-lan', 'Cow-pernicus',
    'Ferdinand', 'Elsie', 'Clarabelle', 'Angus', 'Buttercup',
    'Moo-chelle', 'Barney', 'T-bone', 'Stacy', 'Patches'
  ];
  const DEFAULT_COW_NAME = () => COW_NAMES[Math.floor(Math.random() * COW_NAMES.length)];
  const CURRENT_LOCATION_ZOOM = 13,
        QR_SIZE = 256,
        SCAN_THROTTLE_MS = 100,
        LONG_PRESS_DURATION = 500;
  
  const markers = [];
  let activeMarker = null,
      isDarkMode = localStorage.getItem('darkMode') === 'true',
      lastScanTime = 0;
  let locationMarker = null,
      isTracking = false;
  let isGroupingEnabled = localStorage.getItem('groupingEnabled') !== 'false';
  
  const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  
  const body = document.body,
        splashScreen = document.getElementById('splash-screen'),
        doNotShowAgainCheckbox = document.getElementById('doNotShowAgainCheckbox'),
        darkModeToggleBtn = document.getElementById('darkModeToggleBtn'),
        groupingToggleBtn = document.getElementById('groupingToggleBtn'),
        showSplashBtn = document.getElementById('showSplashBtn'),
        githubLinkBtn = document.getElementById('githubLinkBtn'),
        menuBtn = document.getElementById('menuBtn'),
        sideMenu = document.getElementById('side-menu'),
        qrOverlay = document.getElementById('qrOverlay'),
        qrContainer = document.getElementById('qrCodeContainer'),
        scanOverlay = document.getElementById('scanOverlay'),
        scanVideo = document.getElementById('video'),
        scanMessage = document.getElementById('scanMessage'),
        searchOverlay = document.getElementById('searchOverlay'),
        cowSearchInput = document.getElementById('cowSearchInput'),
        searchBtn = document.getElementById('searchBtn'),
        importQRInput = document.getElementById('importQRInput'),
        locateBtn = document.getElementById('locateBtn'),
        downloadQRBtn = document.getElementById('downloadQRBtn');
  
  const showQRBtn = document.getElementById('showQRBtn');
  const scanQRBtn = document.getElementById('scanQRBtn');
  const importQRBtn = document.getElementById('importQRBtn');
  const clearBtn = document.getElementById('clearBtn');
  
  function markersToCompressedData() {
    const compactData = markers.map(m => {
      const { lat, lng } = m.getLatLng();
      return [
        parseFloat(lat.toFixed(6)),
        parseFloat(lng.toFixed(6)),
        m.options.title,
        m.options.timestamp
      ];
    });
    return JSON.stringify(compactData);
  }
  
  const markerToJSON = m => {
    const { lat, lng } = m.getLatLng();
    return {
      lat,
      lng,
      name: m.options.title,
      time: m.options.timestamp
    };
  };
  const markersToOldJSONString = () => JSON.stringify(markers.map(markerToJSON));
  
  const buildMarkerPopup = marker => {
    const popupHtml = `<div class="marker-popup">
      <span class="close-popup-btn">×</span>
      <h3>${marker.options.title}</h3>
      <p>${marker.options.timestamp}</p>
      <small>${marker.options.coords}</small>
      <div style="display:flex;justify-content:center;gap:4px;margin-top:10px;">
        <button id="editBtn" class="action-btn edit-action">✏️</button>
        <button id="deleteBtn" class="action-btn delete-action">🗑️</button>
      </div>
    </div>`;
    return popupHtml;
  };
  
  function saveMarkers() { localStorage.setItem('cowMarkers', markersToCompressedData()); }
  
  function loadMarkers() {
    const stored = localStorage.getItem('cowMarkers');
    if (!stored) return;
    loadFromJSON(stored);
  }
  
  function addCowMarker(lat, lng, name = DEFAULT_COW_NAME(), time = new Date().toLocaleString()) {
    const markerId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    const marker = L.marker([lat, lng], {
      icon: L.divIcon({ className: 'cow-marker', html: '🐄' }),
      title: name,
      id: markerId
    });
    marker.options.coords = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
    marker.options.timestamp = time;
    marker.bindPopup(buildMarkerPopup(marker), {
      closeButton: false
    });
    markers.push(marker);
    if (isGroupingEnabled) {
      cowMarkers.addLayer(marker);
    } else {
      marker.addTo(map);
    }
    saveMarkers();
    return marker;
  }
  
  function deleteMarker(marker) {
    if (isGroupingEnabled) {
      cowMarkers.removeLayer(marker);
    } else {
      map.removeLayer(marker);
    }
    const i = markers.indexOf(marker);
    if (i > -1) markers.splice(i, 1);
    saveMarkers();
    activeMarker = null;
  }
  
  function showEditNamePopup(marker) {
    const { lat, lng } = marker.getLatLng(),
      popupContent = document.createElement('div');
    popupContent.classList.add('edit-popup-content');
    popupContent.innerHTML = `<h3>Edit Cow Name</h3>
      <div style="display:flex;align-items:center;gap:8px;">
        <input type="text" id="cowNameInput" value="${marker.options.title}">
      </div>
      <div style="display:flex;justify-content:center;gap:8px;margin-top:10px;">
        <button class="save-btn">💾</button>
        <button class="cancel-btn">✖️</button>
      </div>`;
    const popup = L.popup({
      closeButton: false,
      closeOnClick: false
    }).setLatLng([lat, lng]).setContent(popupContent).openOn(map);
    const nameInput = popupContent.querySelector('#cowNameInput'),
      saveBtn = popupContent.querySelector('.save-btn'),
      cancelBtn = popupContent.querySelector('.cancel-btn');

    if (COW_NAMES.includes(marker.options.title)) {
      nameInput.select();
    } else {
      nameInput.setSelectionRange(nameInput.value.length, nameInput.value.length);
    }
    nameInput.focus();
    nameInput.addEventListener('click', e => e.stopPropagation());
    nameInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') saveBtn.click();
    });
    saveBtn.addEventListener('click', () => {
      marker.options.title = nameInput.value || DEFAULT_COW_NAME();
      marker.bindPopup(buildMarkerPopup(marker));
      popup.remove();
      saveMarkers();
    });
    cancelBtn.addEventListener('click', () => popup.remove());
  }
  
  function showConfirmationModal(msg, onConfirm) {
    const html = `<div id="confirmOverlay" class="overlay visible"><div class="popup" style="max-width:300px;"><p>${msg}</p><div style="display:flex;justify-content:center;gap:10px;margin-top:15px;"><button class="confirm-btn">Yes</button><button class="cancel-btn">No</button></div></div></div>`;
    body.insertAdjacentHTML('beforeend', html);
    const overlay = document.getElementById('confirmOverlay');
    overlay.querySelector('.confirm-btn').addEventListener('click', () => {
      onConfirm();
      overlay.remove();
    });
    overlay.querySelector('.cancel-btn').addEventListener('click', () => overlay.remove());
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        overlay.remove();
      }
    });
  }
  function showAlertDialog(msg) {
    const html = `<div id="alertOverlay" class="overlay visible"><div class="popup" style="max-width:300px;"><p>${msg}</p><button class="ok-btn" style="margin-top:15px;">OK</button></div></div>`;
    body.insertAdjacentHTML('beforeend', html);
    const overlay = document.getElementById('alertOverlay');
    overlay.querySelector('.ok-btn').addEventListener('click', () => overlay.remove());
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        overlay.remove();
      }
    });
  }
  function stopCamera() {
    const s = scanVideo.srcObject;
    if (s) {
      s.getTracks().forEach(t => t.stop());
      scanVideo.srcObject = null;
    }
  }
  
  function loadFromJSON(json) {
    try {
      const data = JSON.parse(json);
      if (Array.isArray(data) && data.every(c => Array.isArray(c) && c.length === 4)) {
        markers.forEach(m => {
          if (isGroupingEnabled) {
            cowMarkers.removeLayer(m);
          } else {
            map.removeLayer(m);
          }
        });
        markers.length = 0;
        cowMarkers.clearLayers();
        data.forEach(c => addCowMarker(c[0], c[1], c[2], c[3]));
        showAlertDialog(`Loaded map from new compressed format!`);
      } else if (Array.isArray(data) && data.every(c => typeof c.lat === 'number' && typeof c.lng === 'number' && typeof c.name === 'string')) {
        markers.forEach(m => {
          if (isGroupingEnabled) {
            cowMarkers.removeLayer(m);
          } else {
            map.removeLayer(m);
          }
        });
        markers.length = 0;
        cowMarkers.clearLayers();
        data.forEach(c => addCowMarker(c.lat, c.lng, c.name, c.time || new Date().toLocaleString()));
        showAlertDialog(`Loaded map from old format (for backward compatibility).`);
      } else {
        showAlertDialog('Invalid QR code data format.');
      }
      saveMarkers();
      if (markers.length > 0) map.setView(markers[0].getLatLng(), CURRENT_LOCATION_ZOOM);
      if (isGroupingEnabled) {
        if (!map.hasLayer(cowMarkers)) {
          map.addLayer(cowMarkers);
        }
      } else {
        if (map.hasLayer(cowMarkers)) {
          map.removeLayer(cowMarkers);
        }
      }
    } catch (e) {
      showAlertDialog('Invalid QR code data format or data is corrupt.');
    }
  }
  
  function startScan() {
    const canvas = document.createElement('canvas'),
      ctx = canvas.getContext('2d');
    (function tick() {
      if (!scanOverlay.classList.contains('visible')) return;
      const now = Date.now();
      if (now - lastScanTime < SCAN_THROTTLE_MS) {
        requestAnimationFrame(tick);
        return;
      }
      lastScanTime = now;
      if (scanVideo.readyState === scanVideo.HAVE_ENOUGH_DATA) {
        canvas.height = scanVideo.videoHeight;
        canvas.width = scanVideo.videoWidth;
        ctx.drawImage(scanVideo, 0, 0, canvas.width, canvas.height);
        const img = ctx.getImageData(0, 0, canvas.width, canvas.height),
          code = jsQR(img.data, img.width, img.height, {
            inversionAttempts: "dontInvert"
          });
        if (code) {
          try {
            loadFromJSON(code.data);
            scanOverlay.classList.remove('visible');
            stopCamera();
          } catch {
            scanMessage.textContent = 'Invalid QR code.';
          }
        }
      }
      requestAnimationFrame(tick);
    })();
  }
  
  const map = L.map('map').setView([34.95, -120.43], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);
  
  const cowMarkers = L.markerClusterGroup({
    iconCreateFunction: function(cluster) {
      const count = cluster.getChildCount();
      const size = 50;
      const className = 'cow-cluster-icon';
      
      return L.divIcon({
        html: `<div class="content-wrapper"><span class="cow-emoji">🐄</span><span class="count">${count}</span></div>`,
        className: className,
        iconSize: [size, size]
      });
    }
  });
  
  if (isGroupingEnabled) {
    map.addLayer(cowMarkers);
  }
  
  map.on('popupclose', () => {
    activeMarker = null;
  });
  
  map.on('click', e => {
    if (sideMenu.classList.contains('visible') || document.querySelector('.overlay.visible')) {
      return;
    }
    
    if (activeMarker) {
      map.closePopup();
      return;
    }
    
    showConfirmationModal("Add a new cow marker here?", () => {
      addCowMarker(e.latlng.lat, e.latlng.lng);
    });
  });
  
  map.on('popupopen', e => {
    const m = e.popup._source;
    activeMarker = m;
    const el = e.popup.getElement();

    // Event listener for the new close button
    el.querySelector('.close-popup-btn')?.addEventListener('click', ev => {
      ev.stopPropagation();
      map.closePopup();
    });

    el.querySelector('#editBtn')?.addEventListener('click', ev => {
      ev.stopPropagation();
      map.closePopup();
      showEditNamePopup(m);
    });
    el.querySelector('#deleteBtn')?.addEventListener('click', ev => {
      ev.stopPropagation();
      showConfirmationModal("Delete this marker?", () => deleteMarker(m));
    });
  });
  map.on('popupclose', () => activeMarker = null);
  
  if (locateBtn) {
    locateBtn.onclick = () => {
      if (!isTracking) {
        map.locate({
          setView: true,
          maxZoom: CURRENT_LOCATION_ZOOM,
          watch: true
        });
        isTracking = true;
        locateBtn.classList.add('tracking');
        locateBtn.dataset.tooltip = 'Stop Tracking';
        locateBtn.textContent = '📍';
      } else {
        map.stopLocate();
        isTracking = false;
        locateBtn.classList.remove('tracking');
        locateBtn.dataset.tooltip = 'Start Tracking';
        locateBtn.textContent = '📍';
        if (locationMarker) {
          locationMarker.remove();
          locationMarker = null;
        }
      }
    };
    locateBtn.setAttribute('aria-label', 'Toggle location tracking');
  }
  
  map.on('locationfound', e => {
    if (!locationMarker) {
      locationMarker = L.marker(e.latlng, {
        icon: L.divIcon({
          className: 'cow-marker',
          html: '📍'
        }),
        title: 'Your Location'
      }).addTo(map);
    } else {
      locationMarker.setLatLng(e.latlng);
    }
  });
  map.on('locationerror', () => {
    showAlertDialog('Unable to get your location.');
    if (isTracking) {
      map.stopLocate();
      isTracking = false;
      if (locateBtn) {
        locateBtn.classList.remove('tracking');
        locateBtn.dataset.tooltip = 'Start Tracking';
      }
      if (locationMarker) {
        locationMarker.remove();
        locationMarker = null;
      }
    }
  });
  
  if (clearBtn) {
    clearBtn.onclick = () => showConfirmationModal("Clear all cow markers?", () => {
      if (isGroupingEnabled) {
        cowMarkers.clearLayers();
      } else {
        markers.forEach(m => map.removeLayer(m));
      }
      markers.length = 0;
      localStorage.removeItem('cowMarkers');
      activeMarker = null;
    });
  }
  if (showQRBtn) {
    showQRBtn.onclick = () => {
      const data = markersToCompressedData();
      qrContainer.innerHTML = '';
      const qrCode = new QRCode(qrContainer, {
        text: data,
        width: QR_SIZE,
        height: QR_SIZE,
        colorDark: "#2c3e50",
        colorLight: "#faf9f7",
        correctLevel: QRCode.CorrectLevel.H
      });
      qrOverlay.classList.add('visible');
    };
  }
  if (scanQRBtn) {
    scanQRBtn.onclick = () => {
      scanOverlay.classList.add('visible');
      navigator.mediaDevices?.getUserMedia({
        video: {
          facingMode: 'environment'
        }
      }).then(s => {
        scanVideo.srcObject = s;
        scanVideo.play();
        startScan();
      }).catch(() => scanMessage.textContent = 'Camera access error.');
    };
  }
  
  if (downloadQRBtn) {
    downloadQRBtn.onclick = () => {
      const qrCanvas = qrContainer.querySelector('canvas');
      if (qrCanvas) {
        const dataUrl = qrCanvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = 'cow-map-qr.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } else {
        showAlertDialog("QR code canvas not found.");
      }
    };
  }
  
  if (qrOverlay) {
    qrOverlay.onclick = (e) => {
      if (e.target === qrOverlay) {
        qrOverlay.classList.remove('visible');
      }
    };
  }
  
  if (scanOverlay) {
    scanOverlay.onclick = (e) => {
      if (e.target === scanOverlay) {
        scanOverlay.classList.remove('visible');
        stopCamera();
      }
    };
  }
  
  if (importQRBtn) {
    importQRBtn.onclick = () => importQRInput.click();
  }
  if (importQRInput) {
    importQRInput.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const r = new FileReader();
      r.onload = ev => {
        const img = new Image();
        img.onload = () => {
          const c = document.createElement('canvas'),
            ctx = c.getContext('2d');
          c.width = img.width;
          c.height = img.height;
          ctx.drawImage(img, 0, 0);
          const d = ctx.getImageData(0, 0, c.width, c.height),
            code = jsQR(d.data, d.width, d.height);
          if (code) {
            try {
              loadFromJSON(code.data);
            } catch {
              showAlertDialog('Invalid QR code.');
            }
          } else showAlertDialog('No QR code found.');
        };
        img.src = ev.target.result;
      };
      r.readAsDataURL(file);
    };
  }

  // New search functionality
  function handleSearch() {
    const searchTerm = cowSearchInput.value.trim().toLowerCase();
    if (!searchTerm) {
      showAlertDialog('Please enter a cow name to search for.');
      return;
    }

    const foundMarker = markers.find(m => m.options.title.toLowerCase() === searchTerm);
    if (foundMarker) {
      map.setView(foundMarker.getLatLng(), CURRENT_LOCATION_ZOOM);
      foundMarker.openPopup();
      searchOverlay.classList.remove('visible');
    } else {
      showAlertDialog(`Cow named "${cowSearchInput.value}" not found.`);
    }
  }

  if (searchBtn) {
    searchBtn.onclick = () => {
      searchOverlay.classList.add('visible');
      cowSearchInput.value = '';
      setTimeout(() => cowSearchInput.focus(), 100);
    };
  }
  
  if (document.getElementById('searchExecuteBtn')) {
    document.getElementById('searchExecuteBtn').onclick = handleSearch;
  }

  if (document.getElementById('searchCancelBtn')) {
    document.getElementById('searchCancelBtn').onclick = () => {
      searchOverlay.classList.remove('visible');
    };
  }
  
  if (cowSearchInput) {
    cowSearchInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') handleSearch();
    });
  }

  if (searchOverlay) {
    searchOverlay.onclick = (e) => {
      if (e.target === searchOverlay) {
        searchOverlay.classList.remove('visible');
      }
    };
  }
  
  if (menuBtn) {
    menuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      sideMenu.classList.toggle('visible');
    });
  }
  
  document.addEventListener('click', (e) => {
    if (sideMenu.classList.contains('visible') && !sideMenu.contains(e.target) && !menuBtn.contains(e.target)) {
      sideMenu.classList.remove('visible');
    }
  });
  
  if (darkModeToggleBtn) {
    darkModeToggleBtn.onclick = () => {
      isDarkMode = !isDarkMode;
      body.classList.toggle('dark-mode', isDarkMode);
      darkModeToggleBtn.textContent = isDarkMode ? '⚪' : '⚫';
      darkModeToggleBtn.classList.toggle('light', isDarkMode);
      darkModeToggleBtn.classList.toggle('dark', !isDarkMode);
      localStorage.setItem('darkMode', isDarkMode);
    };
  }
  
  if (showSplashBtn) {
    showSplashBtn.onclick = () => {
      if (splashScreen) {
        splashScreen.classList.add('visible');
      }
    };
  }
  
  if (githubLinkBtn) {
      githubLinkBtn.onclick = () => {
          window.open('https://github.com/topazlad/moo-moo-markers', '_blank');
      };
  }
  
  const updateGroupingBtn = () => {
    if (!groupingToggleBtn) {
      console.error('Error: "groupingToggleBtn" element not found.');
      return;
    }
    groupingToggleBtn.classList.toggle('toggle-off', !isGroupingEnabled);
    groupingToggleBtn.dataset.tooltip = `Toggle Marker Grouping (${isGroupingEnabled ? 'On' : 'Off'})`;
    const emojiSpan = groupingToggleBtn.querySelector('.emoji');
    if (emojiSpan) {
      emojiSpan.textContent = isGroupingEnabled ? '🗂️' : '📁';
    }
  };
  
  if (groupingToggleBtn) {
    groupingToggleBtn.onclick = () => {
      isGroupingEnabled = !isGroupingEnabled;
      localStorage.setItem('groupingEnabled', isGroupingEnabled);
      updateGroupingBtn();
      
      if (map.hasLayer(cowMarkers)) {
        map.removeLayer(cowMarkers);
      }
      markers.forEach(m => {
        if (map.hasLayer(m)) map.removeLayer(m);
      });
      
      if (isGroupingEnabled) {
        cowMarkers.clearLayers();
        cowMarkers.addLayers(markers);
        map.addLayer(cowMarkers);
      } else {
        markers.forEach(m => {
          m.addTo(map);
        });
      }
    };
    updateGroupingBtn();
  }
  
  if (localStorage.getItem('showSplashScreen') !== 'false' && splashScreen) splashScreen.classList.add('visible');
  const okBtn = splashScreen ? splashScreen.querySelector('.ok-btn') : null;
  if (okBtn) {
    okBtn.onclick = () => {
      if (doNotShowAgainCheckbox.checked) localStorage.setItem('showSplashScreen', 'false');
      splashScreen.classList.remove('visible');
    };
  }
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') document.querySelectorAll('.overlay.visible').forEach(o => {
      o.classList.remove('visible');
      stopCamera();
    });
  });
  
  document.querySelectorAll('[data-tooltip]').forEach(btn => {
    let t, timeout;
    const show = () => {
      if (t) t.remove();
      t = document.createElement('div');
      t.className = 'tooltip';
      t.textContent = btn.dataset.tooltip;
      document.body.appendChild(t);
      const r = btn.getBoundingClientRect(),
        tr = t.getBoundingClientRect();
      let l = r.left + r.width / 2;
      if (l < tr.width / 2) l = tr.width / 2;
      else if (l > innerWidth - tr.width / 2) l = innerWidth - tr.width / 2;
      t.style.left = `${l}px`;
      t.style.top = `${r.top-10}px`;
      setTimeout(() => t.classList.add('visible'), 10);
    };
    const hide = () => {
      if (t) {
        t.classList.remove('visible');
        setTimeout(() => t?.remove(), 200);
        t = null;
      }
    };
    
    if (isTouchDevice) {
      let longPressTimeout;
      const handleTouchStart = () => {
        longPressTimeout = setTimeout(show, LONG_PRESS_DURATION);
      };
      const handleTouchEnd = () => {
        clearTimeout(longPressTimeout);
        hide();
      };
      
      btn.addEventListener('touchstart', handleTouchStart);
      btn.addEventListener('touchend', handleTouchEnd);
      btn.addEventListener('touchmove', handleTouchEnd);
    } else {
      btn.onmouseenter = show;
      btn.onmouseleave = hide;
    }
  });
  
  if (body) {
    body.classList.toggle('dark-mode', isDarkMode);
  }
  loadMarkers();
};
</script>
</body>
</html>
