<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Moo Moo Markers - QR Data Sharing</title>
  
  <style>
    * { box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0; height: 100%; width: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background: #faf9f7; color: #2c3e50;
      display: flex; flex-direction: column; overflow: hidden; 
    }
    #map { flex-grow: 1; position: relative; z-index: 0; }
    nav#controls {
      background: #fff; 
      box-shadow: 0 -3px 10px rgba(0,0,0,0.12);
      padding: 10px 12px; 
      display: flex; 
      justify-content: center;
      align-items: center; 
      gap: 10px; 
      user-select: none;
      border-top-left-radius: 12px; 
      border-top-right-radius: 12px;
      z-index: 10; 
      flex-shrink: 0;
      flex-wrap: nowrap;
      overflow-x: auto;
    }
    /* Base button style for all buttons */
    button {
      background: linear-gradient(145deg, #6fcf97, #27ae60);
      border: none; 
      color: white; 
      font-weight: 700; 
      font-size: 0.9rem;
      min-width: 70px;
      height: 50px; 
      border-radius: 14px; 
      cursor: pointer;
      box-shadow: 5px 5px 10px #1e7c45, -5px -5px 10px #48d67f;
      transition: all 0.2s ease; 
      user-select: none; 
      touch-action: manipulation;
      display: flex; 
      justify-content: center; 
      align-items: center; 
      text-align: center;
      line-height: 1.2; 
      padding: 0 8px;
    }
    button:hover, button:focus {
      transform: translateY(-2px);
      box-shadow: 6px 6px 12px #196232, -6px -6px 12px #55e18f;
      outline: none;
    }
    button:active { transform: translateY(1px); background: #1e7c45; box-shadow: inset 2px 2px 6px #144c2d; }
    
    p#instructions {
      text-align: center; font-size: 0.85rem; color: #555; user-select: none; margin-top: 8px; padding: 0 15px;
    }
    .cow-marker { font-size: 30px; transition: transform 0.3s ease; cursor: pointer; user-select: none; }
    .cow-marker.active { transform: scale(2.2); z-index: 9999; filter: drop-shadow(0 0 5px rgba(39,174,96,0.8)); }
    .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center; z-index: 99999; visibility: hidden; opacity: 0; transition: opacity 0.25s ease; }
    .overlay.visible { visibility: visible; opacity: 1; }
    .popup { background: white; padding: 20px 24px 24px 24px; border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); text-align: center; max-width: 90vw; user-select: none; }
    .popup h2 { margin: 0 0 12px 0; font-weight: 700; color: #27ae60; }
    #qrCodeContainer { margin: 0 auto 18px auto; max-width: 300px; max-height: 300px; }
    .popup-close-btn { background: #e74c3c; color: white; border: none; border-radius: 14px; padding: 8px 18px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: background 0.2s ease; }
    .popup-close-btn:hover { background: #c0392b; }
    #video { width: 100%; max-width: 320px; border-radius: 12px; background: black; }
    #scanMessage { margin: 12px 0 0 0; color: #333; font-size: 0.9rem; font-family: monospace; }
    #downloadQRBtn { background: linear-gradient(145deg, #3498db, #2980b9); box-shadow: 5px 5px 10px #1f618d, -5px -5px 10px #4ab3e9; margin-top: 12px; width: auto; height: auto; padding: 8px 18px; }
    #downloadQRBtn:hover { box-shadow: 6px 6px 12px #1a5276, -6px -6px 12px #57c0f6; }
    #downloadQRBtn:active { background: #1f618d; box-shadow: inset 2px 2px 6px #14435f; }
    .leaflet-popup-content small { font-size: 0.7rem; color: #666; display: block; }
    .action-btn { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; cursor: pointer; border: none; margin: 2px; }
    .edit-action { background: #3498db; color: white; }
    .edit-action:hover { background: #2980b9; }
    .delete-action { background: #e74c3c; color: white; }
    .delete-action:hover { background: #c0392b; }
    #importQRInput {
      display: none;
    }
  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<body>

<div id="map"></div>

<nav id="controls" role="region" aria-label="Map Controls">
  <button id="locateBtn">Locate</button>
  <button id="showQRBtn">Show QR</button>
  <button id="scanQRBtn">Scan QR</button>
  <button id="importQRBtn">Import QR</button>
  <input type="file" id="importQRInput" accept="image/*" />
  <button id="clearBtn">Clear All</button>
</nav>
<p id="instructions">Tap map to add cows üêÑ</p>

<div id="qrOverlay" class="overlay"><div class="popup">
  <h2 id="qrTitle">Share This Cow Map</h2>
  <div id="qrCodeContainer"></div>
  <button id="downloadQRBtn">Download QR</button>
  <button class="popup-close-btn">Close</button>
</div></div>

<div id="scanOverlay" class="overlay"><div class="popup">
  <h2 id="scanTitle">Scan Cow Map QR Code</h2>
  <video id="video" autoplay playsinline></video>
  <p id="scanMessage">Point camera at a QR code</p>
  <button class="popup-close-btn">Close</button>
</div></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
(() => {
  const DEFAULT_COW_NAME = 'A New Cow';
  const SINGLE_MARKER_ZOOM = 15;
  const CURRENT_LOCATION_ZOOM = 13;
  const QR_SIZE = 256;
  const MAX_QR_DATA_LENGTH = 2000;
  const SCAN_THROTTLE_MS = 100;

  const markers = [];
  let activeMarker = null;

  const map = L.map('map').setView([34.95, -120.43], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  function saveMarkers() {
    const data = markers.map(m => {
      const { lat, lng } = m.getLatLng();
      return { lat, lng, name: m.options.title };
    });
    localStorage.setItem('cowMarkers', JSON.stringify(data));
  }
  
  function loadMarkers() {
    const storedData = localStorage.getItem('cowMarkers');
    if (storedData) {
      try {
        const data = JSON.parse(storedData);
        data.forEach(cow => addCowMarker(cow.lat, cow.lng, cow.name));
      } catch (e) {
        console.error('Failed to parse stored markers:', e);
      }
    }
  }

  async function getLocationName(lat, lng) {
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1`);
      const data = await res.json();
      return data.address.city || data.address.town || data.address.village || data.address.hamlet || 'Unknown location';
    } catch {
      return 'Location not found';
    }
  }

  function getInfoContent(marker) {
    const name = marker.options.title;
    const location = marker.options.location || 'Loading location...';
    const coords = marker.options.coords;
    return `<b>${name}</b><small> (${location})</small><br><small>Coords: ${coords}</small>`;
  }

  function createCowIcon(active = false) {
    return L.divIcon({
      html: `<div class="cow-marker${active ? ' active' : ''}">üêÑ</div>`,
      className: '',
      iconSize: [30, 30], iconAnchor: [15, 30]
    });
  }

  function enlargeMarker(marker) { marker.setIcon(createCowIcon(true)); marker.setZIndexOffset(1000); }
  function resetMarker(marker) { marker.setIcon(createCowIcon()); marker.setZIndexOffset(0); }

  function updateInstructions() {
    document.getElementById('instructions').textContent =
      markers.length === 0 ? 'No cows yet‚Äîtap to add! üêÑ' : 'Tap map to add more cows üêÑ';
  }

  function addCowMarker(lat, lng, name = DEFAULT_COW_NAME) {
    const marker = L.marker([lat, lng], { icon: createCowIcon(), title: name }).addTo(map);
    marker.options.coords = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
    marker.options.location = null;

    marker.bindPopup(() => getInfoContent(marker));

    marker.on('popupopen', async () => {
      if (activeMarker && activeMarker !== marker) {
        resetMarker(activeMarker);
        activeMarker.closePopup();
      }
      activeMarker = marker;
      enlargeMarker(marker);
      if (!marker.options.location) {
        marker.options.location = await getLocationName(lat, lng);
        if (marker.getPopup().isOpen()) {
          marker.getPopup().setContent(getInfoContent(marker));
        }
      }
    });

    marker.on('popupclose', () => {
      if (activeMarker === marker) {
        resetMarker(marker);
        activeMarker = null;
      }
    });

    // Context menu for edit/delete
    marker.on('contextmenu', () => {
      if (map._popup) map.closePopup();

      const actionContent = `
        <div style="display: flex; justify-content: center; gap: 4px;">
          <button id="editBtn" class="action-btn edit-action">Edit</button>
          <button id="deleteBtn" class="action-btn delete-action">Delete</button>
        </div>`;

      const actionPopup = L.popup()
        .setLatLng(marker.getLatLng())
        .setContent(actionContent)
        .openOn(map);

      setTimeout(() => {
        const editBtn = document.getElementById('editBtn');
        const deleteBtn = document.getElementById('deleteBtn');

        if (editBtn) {
          editBtn.addEventListener('click', () => {
            openNameModal(marker.options.title, (newName) => {
              marker.options.title = newName;
              if (marker._icon) marker._icon.title = newName;
              if (marker.getPopup()) {
                marker.getPopup().setContent(getInfoContent(marker));
                if (!marker.getPopup().isOpen()) {
                  marker.openPopup();
                }
              }
              saveMarkers(); // Save state after editing
            });
            map.closePopup(actionPopup);
          });
        }

        if (deleteBtn) {
          deleteBtn.addEventListener('click', () => {
            if (confirm('Delete this cow?')) {
              map.removeLayer(marker);
              const index = markers.indexOf(marker);
              if (index > -1) markers.splice(index, 1);
              if (activeMarker === marker) activeMarker = null;
              saveMarkers(); // Save state after deleting
              updateInstructions();
            }
            map.closePopup(actionPopup);
          });
        }
      }, 0);
    });

    markers.push(marker);
    updateInstructions();
  }

  function clearAllMarkers() {
    markers.forEach(m => map.removeLayer(m));
    markers.length = 0;
    activeMarker = null;
    localStorage.removeItem('cowMarkers'); // Clear local storage
    updateInstructions();
  }

  // Current location marker without trail (trail removed)
  let currentLocationMarker = null;
  let currentLocationWatchId = null;
  const currentLocationIcon = L.divIcon({
    html: `<div style="font-size:24px;">üìç</div>`,
    className: '',
    iconSize: [24, 24],
    iconAnchor: [12, 12]
  });

  document.getElementById('locateBtn').addEventListener('click', () => {
    if (!navigator.geolocation) return alert('Geolocation not supported.');

    if (currentLocationWatchId !== null) {
      navigator.geolocation.clearWatch(currentLocationWatchId);
      currentLocationWatchId = null;
    }

    currentLocationWatchId = navigator.geolocation.watchPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      if (!currentLocationMarker) {
        currentLocationMarker = L.marker([lat, lng], { icon: currentLocationIcon })
          .addTo(map)
          .bindPopup("You are here");
        map.setView([lat, lng], CURRENT_LOCATION_ZOOM);
      } else {
        currentLocationMarker.setLatLng([lat, lng]);
      }
    }, err => {
      alert('Location error: ' + err.message);
    }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
  });

  // --- QR & scan ---
  const qrOverlay = document.getElementById('qrOverlay');
  const qrCodeContainer = document.getElementById('qrCodeContainer');
  document.getElementById('showQRBtn').addEventListener('click', () => {
    if (markers.length === 0) return alert("Add some cows first!");
    const compactData = markers.map(m => {
      const { lat, lng } = m.getLatLng();
      return [parseFloat(lat.toFixed(5)), parseFloat(lng.toFixed(5)), m.options.title];
    });
    const dataString = JSON.stringify(compactData);
    if (dataString.length > MAX_QR_DATA_LENGTH) return alert('Too many cows for reliable QR.');
    qrCodeContainer.innerHTML = '';
    new QRCode(qrCodeContainer, { text: dataString, width: QR_SIZE, height: QR_SIZE, colorDark: "#000", colorLight: "#fff", correctLevel: QRCode.CorrectLevel.M });
    qrOverlay.classList.add('visible');
  });

  document.getElementById('downloadQRBtn').addEventListener('click', () => {
    const qrCanvas = qrCodeContainer.querySelector('canvas');
    if (qrCanvas) {
      const link = document.createElement('a');
      link.download = 'cow-map-qr.png';
      link.href = qrCanvas.toDataURL('image/png');
      link.click();
    }
  });

  const scanOverlay = document.getElementById('scanOverlay');
  const video = document.getElementById('video');
  let scanStream = null;
  let lastScanTime = 0;

  function openScanner() {
    if (!navigator.mediaDevices) return alert('Camera not available.');
    scanOverlay.classList.add('visible');
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(stream => { scanStream = stream; video.srcObject = stream; video.play(); scanLoop(); })
      .catch(() => { alert('Camera access denied.'); closeScanner(); });
  }

  function closeScanner() {
    if (scanStream) scanStream.getTracks().forEach(t => t.stop());
    scanOverlay.classList.remove('visible');
  }

  function scanLoop() {
    const now = Date.now();
    if (now - lastScanTime < SCAN_THROTTLE_MS) return requestAnimationFrame(scanLoop);
    lastScanTime = now;
    if (video.readyState !== video.HAVE_ENOUGH_DATA) return requestAnimationFrame(scanLoop);
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height);
    if (code) {
      closeScanner();
      processQRCodeData(code.data);
      return;
    }
    requestAnimationFrame(scanLoop);
  }

  function processQRCodeData(dataString) {
    try {
      const loadedData = JSON.parse(dataString);
      if (!Array.isArray(loadedData)) throw new Error();
      clearAllMarkers();
      loadedData.forEach(cow => {
        if (!Array.isArray(cow) || cow.length < 2) return;
        const [lat, lng, name] = cow;   
        addCowMarker(lat, lng, name || 'Imported Cow');
      });

      if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        const bounds = group.getBounds().pad(0.2);
        map.fitBounds(bounds);
        if (markers.length === 1) map.setZoom(SINGLE_MARKER_ZOOM);
      }
    } catch (e) {
      alert("Could not read QR code. Invalid Cow Map format.");
    }
  }

  document.getElementById('scanQRBtn').addEventListener('click', openScanner);

  // Import QR image logic
  const importQRBtn = document.getElementById('importQRBtn');
  const importQRInput = document.getElementById('importQRInput');

  importQRBtn.addEventListener('click', () => {
    importQRInput.value = null;  // reset file input
    importQRInput.click();
  });

  importQRInput.addEventListener('change', () => {
    const file = importQRInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(event) {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        if (code) {
          processQRCodeData(code.data);
        } else {
          alert('No valid QR code found in the image.');
        }
      };
      img.onerror = () => alert('Failed to load image.');
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  });

  document.getElementById('clearBtn').addEventListener('click', clearAllMarkers);
  qrOverlay.querySelector('.popup-close-btn').addEventListener('click', () => qrOverlay.classList.remove('visible'));
  scanOverlay.querySelector('.popup-close-btn').addEventListener('click', closeScanner);

  // Name edit modal helper
  // Creates a prompt modal with Save and Cancel buttons
  function openNameModal(currentName, callback) {
    const modal = document.createElement('div');
    modal.className = 'overlay visible';
    modal.style.zIndex = '100000';

    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.style.maxWidth = '300px';
    popup.style.textAlign = 'center';

    popup.innerHTML = `
      <h2>Edit Cow Name</h2>
      <input type="text" value="${currentName.replace(/"/g, '&quot;')}" style="width: 100%; font-size: 1.1rem; padding: 8px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 8px;" />
      <div style="display: flex; justify-content: center; gap: 12px;">
        <button class="save-btn" style="flex-grow:1; background:#27ae60; color:white; border:none; border-radius: 14px; padding: 8px 0; font-weight:700; cursor:pointer;">Save</button>
        <button class="cancel-btn" style="flex-grow:1; background:#e74c3c; color:white; border:none; border-radius: 14px; padding: 8px 0; font-weight:700; cursor:pointer;">Cancel</button>
      </div>
    `;

    modal.appendChild(popup);
    document.body.appendChild(modal);

    const input = popup.querySelector('input');
    input.focus();
    input.select();

    function closeModal() {
      document.body.removeChild(modal);
    }

    popup.querySelector('.save-btn').addEventListener('click', () => {
      const val = input.value.trim() || currentName;
      callback(val);
      closeModal();
    });

    popup.querySelector('.cancel-btn').addEventListener('click', closeModal);

    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        popup.querySelector('.save-btn').click();
      }
      if (e.key === 'Escape') {
        e.preventDefault();
        closeModal();
      }
    });
  }

  // Map click adds new cow marker using modal for naming
  map.on('click', e => {
    openNameModal(DEFAULT_COW_NAME, (name) => {
      addCowMarker(e.latlng.lat, e.latlng.lng, name);
      saveMarkers(); // Save state after adding
    });
  });

  // Initial setup
  loadMarkers();
  updateInstructions();
})();
</script>

</body>
</html>
